name: Deploy to Production

on:
  push:
    branches: [ main ]
    paths:
      - 'api/**'
      - 'dashboard/**'
      - 'models/**'
      - '.github/workflows/deploy.yml'

jobs:
  notify-deployment:
    name: Notify Deployment
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Get commit info
      id: commit
      run: |
        echo "message=$(git log -1 --pretty=%B)" >> $GITHUB_OUTPUT
        echo "author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT
        echo "sha=$(git log -1 --pretty=%h)" >> $GITHUB_OUTPUT
    
    - name: Notify deployment start
      run: |
        echo "üöÄ Deployment iniciado"
        echo "üìù Commit: ${{ steps.commit.outputs.message }}"
        echo "üë§ Autor: ${{ steps.commit.outputs.author }}"
        echo "üîñ SHA: ${{ steps.commit.outputs.sha }}"
        echo ""
        echo "üì¶ Servicios que se actualizar√°n:"
        echo "   - API (Render): https://telco-churn-api-y9xy.onrender.com"
        echo "   - Dashboard (Streamlit): https://telco-churn-dashboard-ml.streamlit.app"
  
  verify-api:
    name: Verify API Deployment
    runs-on: ubuntu-latest
    needs: notify-deployment
    
    steps:
    - name: Wait for Render deployment
      run: |
        echo "‚è≥ Esperando 60 segundos para que Render detecte el cambio..."
        sleep 60
    
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10.13'
    
    - name: Install dependencies
      run: |
        pip install requests
    
    - name: Verify API is responding
      run: |
        python scripts/monitor_production.py
    
    - name: Notify success
      if: success()
      run: |
        echo "‚úÖ API deployment verificado exitosamente"
    
    - name: Notify failure
      if: failure()
      run: |
        echo "‚ùå API deployment fall√≥ la verificaci√≥n"
        exit 1

  verify-dashboard:
    name: Verify Dashboard Deployment
    runs-on: ubuntu-latest
    needs: notify-deployment
    
    steps:
    - name: Wait for Streamlit deployment
      run: |
        echo "‚è≥ Esperando 90 segundos para que Streamlit Cloud detecte el cambio..."
        sleep 90
    
    - name: Check Dashboard accessibility
      run: |
        response=$(curl -s -o /dev/null -w "%{http_code}" https://telco-churn-dashboard-ml.streamlit.app)
        if [ $response -eq 200 ]; then
          echo "‚úÖ Dashboard est√° accesible (HTTP $response)"
        else
          echo "‚ùå Dashboard no est√° accesible (HTTP $response)"
          exit 1
        fi
    
    - name: Notify success
      if: success()
      run: |
        echo "‚úÖ Dashboard deployment verificado exitosamente"
    
    - name: Notify failure
      if: failure()
      run: |
        echo "‚ùå Dashboard deployment fall√≥ la verificaci√≥n"
        exit 1

  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [verify-api, verify-dashboard]
    if: always()
    
    steps:
    - name: Summary
      run: |
        echo "üìä RESUMEN DE DEPLOYMENT"
        echo "========================"
        echo ""
        echo "üåê URLs de Producci√≥n:"
        echo "   - API: https://telco-churn-api-y9xy.onrender.com"
        echo "   - Dashboard: https://telco-churn-dashboard-ml.streamlit.app"
        echo ""
        echo "üìÖ Fecha: $(date '+%Y-%m-%d %H:%M:%S UTC')"
        echo ""
        if [ "${{ needs.verify-api.result }}" == "success" ] && [ "${{ needs.verify-dashboard.result }}" == "success" ]; then
          echo "‚úÖ Deployment completado exitosamente"
        else
          echo "‚ö†Ô∏è Deployment completado con advertencias"
          echo "   - API: ${{ needs.verify-api.result }}"
          echo "   - Dashboard: ${{ needs.verify-dashboard.result }}"
        fi

